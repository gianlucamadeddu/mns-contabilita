<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MNS Group - Sistema Contabilit√†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            color: #7f8c8d;
            font-size: 1.1em;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .balance {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .positive {
            color: #27ae60;
        }

        .negative {
            color: #e74c3c;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #2c3e50;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: transform 0.3s ease;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-small {
            padding: 8px 15px;
            font-size: 14px;
            width: auto;
            margin-left: 10px;
        }

        .transactions {
            max-height: 400px;
            overflow-y: auto;
        }

        .transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .transaction-item.expense {
            border-left-color: #e74c3c;
        }

        .transaction-details {
            flex: 1;
        }

        .transaction-amount {
            font-weight: bold;
            font-size: 1.1em;
        }

        .transaction-date {
            color: #7f8c8d;
            font-size: 0.9em;
        }

        .transaction-description {
            color: #2c3e50;
            margin: 5px 0;
        }

        .delete-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
        }

        .tab {
            flex: 1;
            padding: 12px;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            border-radius: 8px 8px 0 0;
            font-weight: 500;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        .reports-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-top: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .export-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .user-info {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 14px;
            color: #2c3e50;
        }

        .nav-tabs {
            display: flex;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 5px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .nav-tab {
            flex: 1;
            padding: 15px 25px;
            background: transparent;
            border: none;
            cursor: pointer;
            border-radius: 10px;
            font-weight: 500;
            font-size: 16px;
            color: #2c3e50;
            transition: all 0.3s ease;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: translateY(-2px);
        }

        .page-content {
            display: none;
        }

        .page-content.active {
            display: block;
        }

        .iva-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin: 0;
        }

        .iva-rate-group {
            display: none;
            margin-top: 15px;
        }

        .iva-summary {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .iva-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .iva-debit {
            border-left-color: #e74c3c;
        }

        .iva-credit {
            border-left-color: #27ae60;
        }
    </style>
</head>
<body>
    <div class="user-info">
        üë§ <span id="currentUser">Amministratore</span> | üïí <span id="currentTime"></span>
    </div>

    <div class="container">
        <div class="header">
            <h1>üè¢ MNS Group - Sistema Contabilit√†</h1>
            <p>Gestione contabile aziendale in tempo reale</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showPage('contabilita')">üìä Contabilit√†</button>
            <button class="nav-tab" onclick="showPage('iva')">üßæ Gestione IVA</button>
        </div>

        <!-- PAGINA CONTABILIT√Ä -->
        <div id="contabilita" class="page-content active">

        <div class="stats-grid">
            <div class="stat-card">
                <h3>üí≥ Conto Credem</h3>
                <div class="balance" id="credemBalance">‚Ç¨ 0,00</div>
                <small>Saldo corrente</small>
            </div>
            <div class="stat-card">
                <h3>üí≥ Conto Revolut</h3>
                <div class="balance" id="revolutBalance">‚Ç¨ 0,00</div>
                <small>Saldo corrente</small>
            </div>
            <div class="stat-card">
                <h3>üí∞ Totale Liquidit√†</h3>
                <div class="balance" id="totalBalance">‚Ç¨ 0,00</div>
                <small>Somma di tutti i conti</small>
            </div>
            <div class="stat-card">
                <h3>üìä Bilancio Mensile</h3>
                <div class="balance" id="monthlyBalance">‚Ç¨ 0,00</div>
                <small>Entrate - Uscite questo mese</small>
            </div>
        </div>

        <div class="main-content">
            <div class="section">
                <h2>‚ûï Nuova Operazione</h2>
                <form id="transactionForm">
                    <div class="form-group">
                        <label for="transactionType">Tipo Operazione:</label>
                        <select id="transactionType" required>
                            <option value="">Seleziona tipo</option>
                            <option value="income">üí∞ Entrata</option>
                            <option value="expense">üí∏ Uscita</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="account">Conto:</label>
                        <select id="account" required>
                            <option value="">Seleziona conto</option>
                            <option value="credem">Credem</option>
                            <option value="revolut">Revolut</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="amount">Importo (‚Ç¨):</label>
                        <input type="number" id="amount" step="0.01" min="0" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="description">Descrizione:</label>
                        <input type="text" id="description" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="category">Categoria:</label>
                        <select id="category" required>
                            <option value="">Seleziona categoria</option>
                            <option value="vendite">üíº Vendite</option>
                            <option value="servizi">üîß Servizi</option>
                            <option value="affitto">üè† Affitto</option>
                            <option value="utilities">‚ö° Utenze</option>
                            <option value="marketing">üì± Marketing</option>
                            <option value="materiali">üì¶ Materiali</option>
                            <option value="personale">üë• Personale</option>
                            <option value="tasse">üíº Tasse</option>
                            <option value="altro">üìù Altro</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="date">Data:</label>
                        <input type="date" id="date" required>
                    </div>
                    
                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" id="hasVat" onchange="toggleVatFields()">
                            <label for="hasVat">Operazione soggetta ad IVA</label>
                        </div>
                        <div id="vatFields" class="iva-rate-group">
                            <label for="vatRate">Aliquota IVA (%):</label>
                            <select id="vatRate">
                                <option value="22">22% - Aliquota ordinaria</option>
                                <option value="10">10% - Aliquota ridotta</option>
                                <option value="4">4% - Aliquota super ridotta</option>
                                <option value="0">0% - Esente/Non imponibile</option>
                            </select>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn">Aggiungi Operazione</button>
                </form>
            </div>

            <div class="section">
                <h2>üìã Operazioni Recenti</h2>
                <div class="tabs">
                    <button class="tab active" onclick="showTab('all')">Tutte</button>
                    <button class="tab" onclick="showTab('credem')">Credem</button>
                    <button class="tab" onclick="showTab('revolut')">Revolut</button>
                </div>
                
                <div id="all" class="tab-content active">
                    <div class="transactions" id="allTransactions">
                        <p style="text-align: center; color: #7f8c8d; margin: 50px 0;">Nessuna operazione ancora registrata</p>
                    </div>
                </div>
                
                <div id="credem" class="tab-content">
                    <div class="transactions" id="credemTransactions">
                        <p style="text-align: center; color: #7f8c8d; margin: 50px 0;">Nessuna operazione Credem</p>
                    </div>
                </div>
                
                <div id="revolut" class="tab-content">
                    <div class="transactions" id="revolutTransactions">
                        <p style="text-align: center; color: #7f8c8d; margin: 50px 0;">Nessuna operazione Revolut</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="reports-section">
            <h2>üìà Report e Analisi</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>üíö Entrate Totali</h3>
                    <div class="balance positive" id="totalIncome">‚Ç¨ 0,00</div>
                    <small>Dal primo utilizzo</small>
                </div>
                <div class="stat-card">
                    <h3>üí∏ Uscite Totali</h3>
                    <div class="balance negative" id="totalExpenses">‚Ç¨ 0,00</div>
                    <small>Dal primo utilizzo</small>
                </div>
                <div class="stat-card">
                    <h3>üéØ Entrate Mese</h3>
                    <div class="balance positive" id="monthlyIncome">‚Ç¨ 0,00</div>
                    <small id="currentMonth"></small>
                </div>
                <div class="stat-card">
                    <h3>üí∞ Uscite Mese</h3>
                    <div class="balance negative" id="monthlyExpenses">‚Ç¨ 0,00</div>
                    <small id="currentMonth2"></small>
                </div>
            </div>
            
            <div class="export-buttons">
                <button class="btn" onclick="exportData('csv')">üìä Esporta CSV</button>
                <button class="btn" onclick="downloadAutoBackup()">üíæ Backup Manuale</button>
                <button class="btn" onclick="document.getElementById('restoreInput').click()">üì• Ripristina Backup</button>
                <input type="file" id="restoreInput" accept=".json" style="display: none;" onchange="restoreBackup(this)">
            </div>
            
            <div class="iva-summary" style="margin-top: 20px;">
                <h4>üîÑ Backup Automatico</h4>
                <p><strong>Stato:</strong> <span id="backupStatus">Attivo - Salvataggio automatico ad ogni operazione</span></p>
                <p><strong>Ultimo salvataggio:</strong> <span id="lastSaveTime">Mai</span></p>
                <p><strong>Frequenza backup:</strong> Automatico + Notifica settimanale</p>
                <small style="color: #666;">I tuoi dati sono salvati automaticamente nel browser e non verranno mai persi.</small>
            </div>
        </div>
        </div>

        <!-- PAGINA GESTIONE IVA -->
        <div id="iva" class="page-content">
            <div class="iva-section">
                <h2>üßæ Calcolo IVA da Versare</h2>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>üí∞ IVA a Debito</h3>
                        <div class="balance negative" id="ivaDebito">‚Ç¨ 0,00</div>
                        <small>IVA su vendite/fatture emesse</small>
                    </div>
                    <div class="stat-card">
                        <h3>üí∏ IVA a Credito</h3>
                        <div class="balance positive" id="ivaCredito">‚Ç¨ 0,00</div>
                        <small>IVA su acquisti/fatture ricevute</small>
                    </div>
                    <div class="stat-card">
                        <h3>üìä IVA da Versare</h3>
                        <div class="balance" id="ivaVersare">‚Ç¨ 0,00</div>
                        <small>Debito - Credito</small>
                    </div>
                    <div class="stat-card">
                        <h3>üìÖ Scadenza</h3>
                        <div class="balance" id="scadenzaIva" style="font-size: 1.2em; color: #2c3e50;">16/09/2025</div>
                        <small>Prossimo versamento IVA</small>
                    </div>
                </div>
            </div>

            <div class="main-content">
                <div class="section">
                    <h2>üìà Dettaglio IVA per Aliquota</h2>
                    <div id="ivaByRate">
                        <div class="iva-summary">
                            <h4>Aliquota 22%</h4>
                            <p><strong>Vendite:</strong> <span id="vendite22">‚Ç¨ 0,00</span> - IVA: <span id="ivaVendite22">‚Ç¨ 0,00</span></p>
                            <p><strong>Acquisti:</strong> <span id="acquisti22">‚Ç¨ 0,00</span> - IVA: <span id="ivaAcquisti22">‚Ç¨ 0,00</span></p>
                        </div>
                        <div class="iva-summary">
                            <h4>Aliquota 10%</h4>
                            <p><strong>Vendite:</strong> <span id="vendite10">‚Ç¨ 0,00</span> - IVA: <span id="ivaVendite10">‚Ç¨ 0,00</span></p>
                            <p><strong>Acquisti:</strong> <span id="acquisti10">‚Ç¨ 0,00</span> - IVA: <span id="ivaAcquisti10">‚Ç¨ 0,00</span></p>
                        </div>
                        <div class="iva-summary">
                            <h4>Aliquota 4%</h4>
                            <p><strong>Vendite:</strong> <span id="vendite4">‚Ç¨ 0,00</span> - IVA: <span id="ivaVendite4">‚Ç¨ 0,00</span></p>
                            <p><strong>Acquisti:</strong> <span id="acquisti4">‚Ç¨ 0,00</span> - IVA: <span id="ivaAcquisti4">‚Ç¨ 0,00</span></p>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h2>üìã Operazioni IVA Recenti</h2>
                    <div class="tabs">
                        <button class="tab active" onclick="showIvaTab('all')">Tutte</button>
                        <button class="tab" onclick="showIvaTab('debito')">A Debito</button>
                        <button class="tab" onclick="showIvaTab('credito')">A Credito</button>
                    </div>
                    
                    <div id="ivaAll" class="tab-content active">
                        <div class="transactions" id="allIvaTransactions">
                            <p style="text-align: center; color: #7f8c8d; margin: 50px 0;">Nessuna operazione IVA registrata</p>
                        </div>
                    </div>
                    
                    <div id="ivaDebito" class="tab-content">
                        <div class="transactions" id="debitoIvaTransactions">
                            <p style="text-align: center; color: #7f8c8d; margin: 50px 0;">Nessuna operazione a debito</p>
                        </div>
                    </div>
                    
                    <div id="ivaCredito" class="tab-content">
                        <div class="transactions" id="creditoIvaTransactions">
                            <p style="text-align: center; color: #7f8c8d; margin: 50px 0;">Nessuna operazione a credito</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="reports-section">
                <h2>üìä Esportazione Dati IVA</h2>
                <div class="export-buttons">
                    <button class="btn" onclick="exportIvaData('liquidazione')">üßæ Liquidazione IVA</button>
                    <button class="btn" onclick="exportIvaData('registri')">üìö Registri IVA</button>
                    <button class="btn" onclick="exportIvaData('csv')">üìä Export CSV IVA</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Database in memoria per le transazioni
        let transactions = [];
        let balances = {
            credem: 0,
            revolut: 0
        };

        // Struttura per tracking IVA
        let ivaData = {
            debito: 0,    // IVA su vendite
            credito: 0,   // IVA su acquisti
            byRate: {
                22: { vendite: 0, acquisti: 0, ivaVendite: 0, ivaAcquisti: 0 },
                10: { vendite: 0, acquisti: 0, ivaVendite: 0, ivaAcquisti: 0 },
                4: { vendite: 0, acquisti: 0, ivaVendite: 0, ivaAcquisti: 0 },
                0: { vendite: 0, acquisti: 0, ivaVendite: 0, ivaAcquisti: 0 }
            }
        };

        // Sistema di backup automatico
        function autoSave() {
            const data = {
                transactions: transactions,
                balances: balances,
                ivaData: ivaData,
                lastUpdate: new Date().toISOString(),
                version: '1.0'
            };
            
            // In ambiente reale, salva nel localStorage
            try {
                localStorage.setItem('mns_contabilita_data', JSON.stringify(data));
                localStorage.setItem('mns_contabilita_last_backup', Date.now().toString());
                console.log('‚úÖ Dati salvati automaticamente');
            } catch (e) {
                console.log('‚ÑπÔ∏è Ambiente demo - salvataggio simulato');
            }
        }

        function autoLoad() {
            try {
                const savedData = localStorage.getItem('mns_contabilita_data');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    transactions = data.transactions || [];
                    balances = data.balances || { credem: 0, revolut: 0 };
                    ivaData = data.ivaData || {
                        debito: 0, credito: 0,
                        byRate: {
                            22: { vendite: 0, acquisti: 0, ivaVendite: 0, ivaAcquisti: 0 },
                            10: { vendite: 0, acquisti: 0, ivaVendite: 0, ivaAcquisti: 0 },
                            4: { vendite: 0, acquisti: 0, ivaVendite: 0, ivaAcquisti: 0 },
                            0: { vendite: 0, acquisti: 0, ivaVendite: 0, ivaAcquisti: 0 }
                        }
                    };
                    console.log('‚úÖ Dati caricati dal salvataggio automatico');
                    updateUI();
                    
                    // Aggiorna timestamp se disponibile
                    if (data.lastUpdate) {
                        const lastUpdate = new Date(data.lastUpdate);
                        document.getElementById('lastSaveTime').textContent = lastUpdate.toLocaleString('it-IT');
                    }
                    
                    return true;
                }
            } catch (e) {
                console.log('‚ÑπÔ∏è Nessun salvataggio trovato o ambiente demo');
            }
            return false;
        }

        function checkBackupStatus() {
            try {
                const lastBackup = localStorage.getItem('mns_contabilita_last_backup');
                if (!lastBackup) return;
                
                const lastBackupDate = new Date(parseInt(lastBackup));
                const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
                
                if (lastBackupDate < weekAgo) {
                    showBackupNotification();
                }
            } catch (e) {
                // Ambiente demo
            }
        }

        function showBackupNotification() {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: linear-gradient(135deg, #f39c12, #e67e22);
                color: white;
                padding: 15px 25px;
                border-radius: 10px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                z-index: 1000;
                font-weight: 500;
            `;
            notification.innerHTML = `
                üíæ Backup automatico disponibile! 
                <button onclick="downloadAutoBackup(); this.parentElement.remove();" 
                        style="margin-left: 10px; padding: 5px 10px; border: none; border-radius: 5px; cursor: pointer;">
                    Scarica
                </button>
                <button onclick="this.parentElement.remove();" 
                        style="margin-left: 5px; padding: 5px 10px; border: none; border-radius: 5px; cursor: pointer;">
                    ‚ùå
                </button>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 10000);
        }

        function downloadAutoBackup() {
            const data = {
                transactions: transactions,
                balances: balances,
                ivaData: ivaData,
                exportDate: new Date().toISOString(),
                type: 'auto_backup',
                version: '1.0'
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = `MNS_Group_AutoBackup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            
            // Aggiorna timestamp backup
            try {
                localStorage.setItem('mns_contabilita_last_backup', Date.now().toString());
            } catch (e) {}
        }

        // Inizializzazione
        document.addEventListener('DOMContentLoaded', function() {
            setTodayDate();
            updateClock();
            setInterval(updateClock, 1000);
            updateMonthLabels();
            
            // Carica dati salvati o dati di esempio
            if (!autoLoad()) {
                loadSampleData();
            }
            
            // Controlla stato backup settimanale
            checkBackupStatus();
            
            // Backup automatico ogni ora (in background)
            setInterval(autoSave, 60 * 60 * 1000); // ogni ora
        });

        function setTodayDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date').value = today;
        }

        function updateClock() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('it-IT');
            document.getElementById('currentTime').textContent = timeString;
        }

        function updateMonthLabels() {
            const monthNames = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno',
                              'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];
            const currentMonth = monthNames[new Date().getMonth()];
            document.getElementById('currentMonth').textContent = currentMonth;
            document.getElementById('currentMonth2').textContent = currentMonth;
        }

        // Gestione navigazione pagine
        function showPage(pageName) {
            // Nascondi tutte le pagine
            const pages = document.querySelectorAll('.page-content');
            pages.forEach(page => page.classList.remove('active'));
            
            // Rimuovi classe active da tutti i nav tab
            const navTabs = document.querySelectorAll('.nav-tab');
            navTabs.forEach(tab => tab.classList.remove('active'));
            
            // Mostra la pagina selezionata
            document.getElementById(pageName).classList.add('active');
            event.target.classList.add('active');
            
            // Aggiorna i dati IVA se stiamo andando alla pagina IVA
            if (pageName === 'iva') {
                updateIvaCalculations();
            }
        }

        // Gestione campi IVA
        function toggleVatFields() {
            const hasVat = document.getElementById('hasVat').checked;
            const vatFields = document.getElementById('vatFields');
            vatFields.style.display = hasVat ? 'block' : 'none';
        }

        // Gestione form transazioni
        document.getElementById('transactionForm').addEventListener('submit', function(e) {
            e.preventDefault();
            addTransaction();
        });

        function addTransaction() {
            const type = document.getElementById('transactionType').value;
            const account = document.getElementById('account').value;
            const amount = parseFloat(document.getElementById('amount').value);
            const description = document.getElementById('description').value;
            const category = document.getElementById('category').value;
            const date = document.getElementById('date').value;
            const hasVat = document.getElementById('hasVat').checked;
            const vatRate = hasVat ? parseInt(document.getElementById('vatRate').value) : 0;

            if (!type || !account || !amount || !description || !category || !date) {
                alert('Compila tutti i campi!');
                return;
            }

            // Calcolo IVA
            let vatAmount = 0;
            let netAmount = amount;
            
            if (hasVat && vatRate > 0) {
                // L'importo inserito include gi√† l'IVA
                netAmount = amount / (1 + vatRate / 100);
                vatAmount = amount - netAmount;
            }

            const transaction = {
                id: Date.now(),
                type: type,
                account: account,
                amount: amount,
                netAmount: netAmount,
                vatAmount: vatAmount,
                vatRate: vatRate,
                hasVat: hasVat,
                description: description,
                category: category,
                date: date,
                timestamp: new Date().toISOString()
            };

            transactions.unshift(transaction); // Aggiungi all'inizio

            // Aggiorna saldi
            if (type === 'income') {
                balances[account] += amount;
                // IVA a debito (da versare) sulle vendite
                if (hasVat && vatRate > 0) {
                    ivaData.debito += vatAmount;
                    ivaData.byRate[vatRate].vendite += netAmount;
                    ivaData.byRate[vatRate].ivaVendite += vatAmount;
                }
            } else {
                balances[account] -= amount;
                // IVA a credito (detraibile) sugli acquisti
                if (hasVat && vatRate > 0) {
                    ivaData.credito += vatAmount;
                    ivaData.byRate[vatRate].acquisti += netAmount;
                    ivaData.byRate[vatRate].ivaAcquisti += vatAmount;
                }
            }

            updateUI();
            document.getElementById('transactionForm').reset();
            document.getElementById('vatFields').style.display = 'none';
            setTodayDate();
            
            // Feedback visivo
            alert('Operazione aggiunta con successo!');
        }

        function deleteTransaction(id) {
            if (confirm('Sei sicuro di voler eliminare questa operazione?')) {
                const transaction = transactions.find(t => t.id === id);
                if (transaction) {
                    // Ripristina il saldo
                    if (transaction.type === 'income') {
                        balances[transaction.account] -= transaction.amount;
                        // Ripristina IVA a debito
                        if (transaction.hasVat && transaction.vatRate > 0) {
                            ivaData.debito -= transaction.vatAmount;
                            ivaData.byRate[transaction.vatRate].vendite -= transaction.netAmount;
                            ivaData.byRate[transaction.vatRate].ivaVendite -= transaction.vatAmount;
                        }
                    } else {
                        balances[transaction.account] += transaction.amount;
                        // Ripristina IVA a credito
                        if (transaction.hasVat && transaction.vatRate > 0) {
                            ivaData.credito -= transaction.vatAmount;
                            ivaData.byRate[transaction.vatRate].acquisti -= transaction.netAmount;
                            ivaData.byRate[transaction.vatRate].ivaAcquisti -= transaction.vatAmount;
                        }
                    }
                    
                    transactions = transactions.filter(t => t.id !== id);
                    updateUI();
                }
            }
        }

        function updateUI() {
            updateBalances();
            updateTransactionsList();
            updateReports();
            updateIvaCalculations();
            
            // Salvataggio automatico ad ogni modifica
            autoSave();
        }

        // Nuove funzioni per gestione IVA
        function updateIvaCalculations() {
            // Aggiorna i totali IVA
            document.getElementById('ivaDebito').textContent = formatCurrency(ivaData.debito);
            document.getElementById('ivaCredito').textContent = formatCurrency(ivaData.credito);
            
            const ivaVersare = ivaData.debito - ivaData.credito;
            document.getElementById('ivaVersare').textContent = formatCurrency(ivaVersare);
            document.getElementById('ivaVersare').className = 'balance ' + (ivaVersare >= 0 ? 'negative' : 'positive');
            
            // Aggiorna dettagli per aliquota
            updateIvaByRate();
            updateIvaTransactionsList();
        }

        function updateIvaByRate() {
            const rates = [22, 10, 4];
            rates.forEach(rate => {
                const data = ivaData.byRate[rate];
                document.getElementById(`vendite${rate}`).textContent = formatCurrency(data.vendite);
                document.getElementById(`ivaVendite${rate}`).textContent = formatCurrency(data.ivaVendite);
                document.getElementById(`acquisti${rate}`).textContent = formatCurrency(data.acquisti);
                document.getElementById(`ivaAcquisti${rate}`).textContent = formatCurrency(data.ivaAcquisti);
            });
        }

        function updateIvaTransactionsList() {
            const ivaTransactions = transactions.filter(t => t.hasVat && t.vatRate > 0);
            const debitoTransactions = ivaTransactions.filter(t => t.type === 'income');
            const creditoTransactions = ivaTransactions.filter(t => t.type === 'expense');
            
            updateIvaTransactionsForTab('all', ivaTransactions);
            updateIvaTransactionsForTab('debito', debitoTransactions);
            updateIvaTransactionsForTab('credito', creditoTransactions);
        }

        function updateIvaTransactionsForTab(tabId, transactionList) {
            const container = document.getElementById(tabId + 'IvaTransactions');
            
            if (transactionList.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #7f8c8d; margin: 50px 0;">Nessuna operazione IVA registrata</p>';
                return;
            }

            container.innerHTML = transactionList.map(transaction => {
                const icon = transaction.type === 'income' ? 'üí∞' : 'üí∏';
                const ivaClass = transaction.type === 'income' ? 'iva-debit' : 'iva-credit';
                const ivaLabel = transaction.type === 'income' ? 'A DEBITO' : 'A CREDITO';
                
                return `
                    <div class="iva-item ${ivaClass}">
                        <div class="transaction-details">
                            <div class="transaction-description">${icon} ${transaction.description}</div>
                            <div class="transaction-date">
                                ${formatDate(transaction.date)} | IVA ${transaction.vatRate}% ${ivaLabel} | ${transaction.account.toUpperCase()}
                            </div>
                            <div style="font-size: 0.9em; color: #666;">
                                Imponibile: ${formatCurrency(transaction.netAmount)} | IVA: ${formatCurrency(transaction.vatAmount)}
                            </div>
                        </div>
                        <div>
                            <span class="transaction-amount">${formatCurrency(transaction.amount)}</span>
                            <button class="delete-btn" onclick="deleteTransaction(${transaction.id})">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function showIvaTab(tabName) {
            // Nascondi tutti i tab content IVA
            const tabContents = document.querySelectorAll('#iva .tab-content');
            tabContents.forEach(content => content.classList.remove('active'));
            
            // Rimuovi classe active da tutti i tab IVA
            const tabs = document.querySelectorAll('#iva .tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // Mostra il tab selezionato
            document.getElementById('iva' + tabName.charAt(0).toUpperCase() + tabName.slice(1)).classList.add('active');
            event.target.classList.add('active');
        }

        function updateBalances() {
            document.getElementById('credemBalance').textContent = formatCurrency(balances.credem);
            document.getElementById('revolutBalance').textContent = formatCurrency(balances.revolut);
            
            const total = balances.credem + balances.revolut;
            document.getElementById('totalBalance').textContent = formatCurrency(total);
            
            // Colori per i saldi
            document.getElementById('credemBalance').className = 'balance ' + (balances.credem >= 0 ? 'positive' : 'negative');
            document.getElementById('revolutBalance').className = 'balance ' + (balances.revolut >= 0 ? 'positive' : 'negative');
            document.getElementById('totalBalance').className = 'balance ' + (total >= 0 ? 'positive' : 'negative');
        }

        function updateTransactionsList() {
            updateTransactionsForTab('all', transactions);
            updateTransactionsForTab('credem', transactions.filter(t => t.account === 'credem'));
            updateTransactionsForTab('revolut', transactions.filter(t => t.account === 'revolut'));
        }

        function updateTransactionsForTab(tabId, transactionList) {
            const container = document.getElementById(tabId + 'Transactions');
            
            if (transactionList.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #7f8c8d; margin: 50px 0;">Nessuna operazione registrata</p>';
                return;
            }

            container.innerHTML = transactionList.map(transaction => {
                const icon = transaction.type === 'income' ? 'üí∞' : 'üí∏';
                const amountClass = transaction.type === 'income' ? 'positive' : 'negative';
                const amountSign = transaction.type === 'income' ? '+' : '-';
                const ivaInfo = transaction.hasVat && transaction.vatRate > 0 ? 
                    ` | IVA ${transaction.vatRate}%: ${formatCurrency(transaction.vatAmount)}` : '';
                
                return `
                    <div class="transaction-item ${transaction.type}">
                        <div class="transaction-details">
                            <div class="transaction-description">${icon} ${transaction.description}</div>
                            <div class="transaction-date">${formatDate(transaction.date)} | ${transaction.category} | ${transaction.account.toUpperCase()}${ivaInfo}</div>
                        </div>
                        <div>
                            <span class="transaction-amount ${amountClass}">${amountSign}${formatCurrency(transaction.amount)}</span>
                            <button class="delete-btn" onclick="deleteTransaction(${transaction.id})">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateReports() {
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            
            const totalIncome = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const totalExpenses = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            
            const monthlyIncome = transactions.filter(t => {
                const transactionDate = new Date(t.date);
                return t.type === 'income' && 
                       transactionDate.getMonth() === currentMonth && 
                       transactionDate.getFullYear() === currentYear;
            }).reduce((sum, t) => sum + t.amount, 0);
            
            const monthlyExpenses = transactions.filter(t => {
                const transactionDate = new Date(t.date);
                return t.type === 'expense' && 
                       transactionDate.getMonth() === currentMonth && 
                       transactionDate.getFullYear() === currentYear;
            }).reduce((sum, t) => sum + t.amount, 0);
            
            document.getElementById('totalIncome').textContent = formatCurrency(totalIncome);
            document.getElementById('totalExpenses').textContent = formatCurrency(totalExpenses);
            document.getElementById('monthlyIncome').textContent = formatCurrency(monthlyIncome);
            document.getElementById('monthlyExpenses').textContent = formatCurrency(monthlyExpenses);
            document.getElementById('monthlyBalance').textContent = formatCurrency(monthlyIncome - monthlyExpenses);
            document.getElementById('monthlyBalance').className = 'balance ' + ((monthlyIncome - monthlyExpenses) >= 0 ? 'positive' : 'negative');
        }

        function showTab(tabName) {
            // Nascondi tutti i tab content
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => content.classList.remove('active'));
            
            // Rimuovi classe active da tutti i tab
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // Mostra il tab selezionato
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('it-IT', {
                style: 'currency',
                currency: 'EUR'
            }).format(amount);
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('it-IT');
        }

        function exportData(format) {
            if (format === 'csv') {
                let csv = 'Data,Tipo,Conto,Importo,Imponibile,IVA,Aliquota_IVA,Descrizione,Categoria\n';
                transactions.forEach(t => {
                    csv += `${t.date},${t.type === 'income' ? 'Entrata' : 'Uscita'},${t.account},${t.amount},${t.netAmount || t.amount},${t.vatAmount || 0},${t.vatRate || 0},"${t.description}",${t.category}\n`;
                });
                
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `MNS_Group_Contabilita_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
            } else if (format === 'pdf') {
                alert('Funzione PDF in sviluppo. Usa CSV per ora.');
            }
        }

        function exportIvaData(type) {
            if (type === 'liquidazione') {
                // Export liquidazione IVA
                let csv = 'Periodo,IVA_Debito,IVA_Credito,IVA_da_Versare\n';
                const currentMonth = new Date().toISOString().slice(0, 7);
                csv += `${currentMonth},${ivaData.debito.toFixed(2)},${ivaData.credito.toFixed(2)},${(ivaData.debito - ivaData.credito).toFixed(2)}\n`;
                
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `Liquidazione_IVA_${currentMonth}.csv`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
            } else if (type === 'registri') {
                // Export registri IVA
                const ivaTransactions = transactions.filter(t => t.hasVat && t.vatRate > 0);
                let csv = 'Data,Tipo,Descrizione,Imponibile,Aliquota,IVA,Totale\n';
                ivaTransactions.forEach(t => {
                    csv += `${t.date},${t.type === 'income' ? 'Vendita' : 'Acquisto'},"${t.description}",${t.netAmount.toFixed(2)},${t.vatRate}%,${t.vatAmount.toFixed(2)},${t.amount.toFixed(2)}\n`;
                });
                
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `Registri_IVA_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
            } else if (type === 'csv') {
                // Export completo dati IVA
                exportData('csv');
            }
        }

        function backupData() {
            // Funzione legacy - ora usa downloadAutoBackup
            downloadAutoBackup();
        }

        function restoreBackup(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // Verifica formato backup
                    if (!data.transactions || !data.balances) {
                        alert('‚ùå File di backup non valido!');
                        return;
                    }
                    
                    if (confirm('‚ö†Ô∏è Sei sicuro di voler ripristinare il backup? Tutti i dati attuali verranno sostituiti.')) {
                        transactions = data.transactions || [];
                        balances = data.balances || { credem: 0, revolut: 0 };
                        ivaData = data.ivaData || {
                            debito: 0, credito: 0,
                            byRate: {
                                22: { vendite: 0, acquisti: 0, ivaVendite: 0, ivaAcquisti: 0 },
                                10: { vendite: 0, acquisti: 0, ivaVendite: 0, ivaAcquisti: 0 },
                                4: { vendite: 0, acquisti: 0, ivaVendite: 0, ivaAcquisti: 0 },
                                0: { vendite: 0, acquisti: 0, ivaVendite: 0, ivaAcquisti: 0 }
                            }
                        };
                        
                        updateUI();
                        updateLastSaveTime();
                        alert('‚úÖ Backup ripristinato con successo!');
                    }
                } catch (error) {
                    alert('‚ùå Errore nel ripristino del backup: file corrotto o formato non valido');
                }
            };
            reader.readAsText(file);
            
            // Reset input
            input.value = '';
        }

        function updateLastSaveTime() {
            const now = new Date();
            const timeString = now.toLocaleString('it-IT');
            document.getElementById('lastSaveTime').textContent = timeString;
        }

        // Override della funzione autoSave per aggiornare anche l'interfaccia
        function autoSave() {
            const data = {
                transactions: transactions,
                balances: balances,
                ivaData: ivaData,
                lastUpdate: new Date().toISOString(),
                version: '1.0'
            };
            
            // In ambiente reale, salva nel localStorage
            try {
                localStorage.setItem('mns_contabilita_data', JSON.stringify(data));
                localStorage.setItem('mns_contabilita_last_backup', Date.now().toString());
                updateLastSaveTime();
                console.log('‚úÖ Dati salvati automaticamente');
            } catch (e) {
                console.log('‚ÑπÔ∏è Ambiente demo - salvataggio simulato');
                updateLastSaveTime(); // Aggiorna comunque l'interfaccia
            }
        }

        function loadSampleData() {
            // Dati di esempio per mostrare il funzionamento
            const sampleTransactions = [
                {
                    id: 1,
                    type: 'income',
                    account: 'credem',
                    amount: 6100,
                    netAmount: 5000,
                    vatAmount: 1100,
                    vatRate: 22,
                    hasVat: true,
                    description: 'Fattura cliente ABC',
                    category: 'vendite',
                    date: '2025-08-20',
                    timestamp: new Date('2025-08-20').toISOString()
                },
                {
                    id: 2,
                    type: 'expense',
                    account: 'revolut',
                    amount: 1200,
                    netAmount: 1200,
                    vatAmount: 0,
                    vatRate: 0,
                    hasVat: false,
                    description: 'Affitto ufficio',
                    category: 'affitto',
                    date: '2025-08-15',
                    timestamp: new Date('2025-08-15').toISOString()
                },
                {
                    id: 3,
                    type: 'income',
                    account: 'revolut',
                    amount: 2750,
                    netAmount: 2500,
                    vatAmount: 250,
                    vatRate: 10,
                    hasVat: true,
                    description: 'Consulenza tecnica',
                    category: 'servizi',
                    date: '2025-08-18',
                    timestamp: new Date('2025-08-18').toISOString()
                },
                {
                    id: 4,
                    type: 'expense',
                    account: 'credem',
                    amount: 610,
                    netAmount: 500,
                    vatAmount: 110,
                    vatRate: 22,
                    hasVat: true,
                    description: 'Acquisto materiali',
                    category: 'materiali',
                    date: '2025-08-19',
                    timestamp: new Date('2025-08-19').toISOString()
                }
            ];

            // Carica solo se non ci sono gi√† transazioni
            if (transactions.length === 0) {
                transactions = sampleTransactions;
                
                // Calcola i saldi e l'IVA
                transactions.forEach(t => {
                    if (t.type === 'income') {
                        balances[t.account] += t.amount;
                        if (t.hasVat && t.vatRate > 0) {
                            ivaData.debito += t.vatAmount;
                            ivaData.byRate[t.vatRate].vendite += t.netAmount;
                            ivaData.byRate[t.vatRate].ivaVendite += t.vatAmount;
                        }
                    } else {
                        balances[t.account] -= t.amount;
                        if (t.hasVat && t.vatRate > 0) {
                            ivaData.credito += t.vatAmount;
                            ivaData.byRate[t.vatRate].acquisti += t.netAmount;
                            ivaData.byRate[t.vatRate].ivaAcquisti += t.vatAmount;
                        }
                    }
                });
                
                updateUI();
            }
        }
    </script>
</body>
</html>
